

==== res:///core/ecs/data/attribute_layer.gd ====
# res://core/ecs/data/attribute_layer.gd
class_name AttributeLayer extends Resource

# åŸºç¡€å±æ€§
@export var health: int = 0
@export var mana: int = 0

# æ”»å‡»å±æ€§
@export var min_attack: int = 0
@export var max_attack: int = 0
@export var min_magic_attack: int = 0    # æœ€å°é­”æ³•æ”»å‡»
@export var max_magic_attack: int = 0    # æœ€å¤§é­”æ³•æ”»å‡»

# é˜²å¾¡å±æ€§
@export var min_defense: int = 0
@export var max_defense: int = 0
@export var min_magic_defense: int = 0
@export var max_magic_defense: int = 0

# ç‰¹æ®Šå±æ€§
@export var accuracy: int = 0      # å‡†ç¡®
@export var agility: int = 0       # æ•æ·
@export var luck: int = 0          # å¹¸è¿
@export var curse: int = 0         # è¯…å’’

# éšè—å±æ€§
@export var magic_dodge: float = 0.0    # é­”æ³•èº²é¿
@export var critical_rate: float = 0.0  # æš´å‡»ç‡
@export var attack_speed: float = 1.0   # æ”»å‡»é€Ÿåº¦

# åºåˆ—åŒ–
func serialize() -> Dictionary:
	return {
		"health": health,
		"mana": mana,
		"min_attack": min_attack,
		"max_attack": max_attack,
		"min_magic_attack": min_magic_attack,
		"max_magic_attack": max_magic_attack,
		
		"min_defense": min_defense,
		"max_defense": max_defense,
		"min_magic_defense": min_magic_defense,
		"max_magic_defense": max_magic_defense,
		
		"accuracy": accuracy,
		"agility": agility,
		"luck": luck,
		"curse": curse,
		"magic_dodge": magic_dodge,
		"critical_rate": critical_rate,
		"attack_speed": attack_speed
	}

# ååºåˆ—åŒ–
func deserialize(data: Dictionary):
	health = data.get("health", 0)
	mana = data.get("mana", 0)
	min_attack = data.get("min_attack", 0)
	max_attack = data.get("max_attack", 0)
	min_magic_attack = data.get("min_magic_attack", 0)
	max_magic_attack = data.get("max_magic_attack", 0)
	
	min_defense = data.get("min_defense", 0)
	max_defense = data.get("max_defense", 0)
	min_magic_defense = data.get("min_magic_defense", 0)
	max_magic_defense = data.get("max_magic_defense", 0)
	
	accuracy = data.get("accuracy", 0)
	agility = data.get("agility", 0)
	luck = data.get("luck", 0)
	curse = data.get("curse", 0)
	magic_dodge = data.get("magic_dodge", 0.0)
	critical_rate = data.get("critical_rate", 0.0)
	attack_speed = data.get("attack_speed", 1.0)


==== res:///core/ecs/data/combat/combat_attributes_base.gd ====
# res://core/ecs/data/combat/combat_attributes_base.gd
class_name CombatAttributesBase extends Resource

# åŸºç¡€å±æ€§è®¿é—®
func get_health() -> int:
	return 0

func get_mana() -> int:
	return 0

func get_min_attack() -> int:
	return 0

func get_max_attack() -> int:
	return 0

func get_min_magic_attack() -> int:
	return 0

func get_max_magic_attack() -> int:
	return 0
	
func get_min_defense() -> int:
	return 0

func get_max_defense() -> int:
	return 0

func get_min_magic_defense() -> int:
	return 0
	
func get_max_magic_defense() -> int:
	return 0

func get_accuracy() -> int:
	return 0

func get_agility() -> int:
	return 0

func get_luck() -> int:
	return 0

func get_curse() -> int:
	return 0

func get_magic_dodge() -> float:
	return 0

func get_critical_rate() -> float:
	return 0

func get_attack_speed() -> float:
	return 0

# åºåˆ—åŒ–
func serialize() -> Dictionary:
	return {
	}

# ååºåˆ—åŒ–
func deserialize(_data: Dictionary):
	pass

func get_class_name() -> String:
	return "CombatAttributesBase"


==== res:///core/ecs/data/combat/monster_combat_attributes.gd ====
# res://core/ecs/data/combat/monster_combat_attributes.gd
class_name MonsterCombatAttributes extends CombatAttributesBase

@export var base: AttributeLayer = AttributeLayer.new()  # é…è¡¨æ•°æ®
@export var buff: AttributeLayer = AttributeLayer.new()  # BuffåŠ æˆ

# é‡å†™è®¡ç®—æ–¹æ³•ï¼ˆåŸºç¡€ + Buffï¼‰
func get_health() -> int:
	return base.health + buff.health

func get_mana() -> int:
	return base.mana + buff.mana

func get_min_attack() -> int:
	return base.min_attack + buff.min_attack

func get_max_attack() -> int:
	return base.max_attack + buff.max_attack

func get_min_magic_attack() -> int:
	return base.min_magic_attack + buff.min_magic_attack

func get_max_magic_attack() -> int:
	return base.max_magic_attack + buff.max_magic_attack
	
func get_min_defense() -> int:
	return base.min_defense + buff.min_defense

func get_max_defense() -> int:
	return base.max_defense + buff.max_defense

func get_min_magic_defense() -> int:
	return base.min_magic_defense + buff.min_magic_defense
	
func get_max_magic_defense() -> int:
	return base.max_magic_defense + buff.max_magic_defense
	
func get_accuracy() -> int:
	return base.accuracy + buff.accuracy

func get_agility() -> int:
	return base.agility + buff.agility

func get_luck() -> int:
	return base.luck + buff.luck

func get_curse() -> int:
	return base.curse + buff.curse

func get_magic_dodge() -> float:
	return base.magic_dodge + buff.magic_dodge

func get_critical_rate() -> float:
	return base.critical_rate + buff.critical_rate

func get_attack_speed() -> float:
	return base.attack_speed + buff.attack_speed

func get_class_name() -> String:
	return "MonsterCombatAttributes"


==== res:///core/ecs/data/combat/npc_combat_attributes.gd ====
# res://core/ecs/data/combat/npc_combat_attributes.gd
class_name NPCCombatAttributes extends CombatAttributesBase
# NPCåªéœ€è¦åŸºç¡€å±‚ï¼Œä¸éœ€è¦é‡å†™ä»»ä½•æ–¹æ³•
# æˆ–è€…å¦‚æœNPCå®Œå…¨æ²¡æœ‰æˆ˜æ–—å±æ€§ï¼Œå¯ä»¥å®Œå…¨ä¸ç”¨è¿™ä¸ªç±»


==== res:///core/ecs/data/combat/player_combat_attributes.gd ====
# res://core/ecs/data/combat/player_combat_attributes.gd
class_name PlayerCombatAttributes extends CombatAttributesBase

@export var job: AttributeLayer = AttributeLayer.new()       # èŒä¸šåŸºç¡€æ•°æ®
@export var level: AttributeLayer = AttributeLayer.new()     # ç­‰çº§åŠ æˆ
@export var equipment: AttributeLayer = AttributeLayer.new() # è£…å¤‡åŠ æˆ  
@export var buff: AttributeLayer = AttributeLayer.new()      # BuffåŠ æˆ
@export var passive: AttributeLayer = AttributeLayer.new()   # ğŸ†• è¢«åŠ¨æŠ€èƒ½åŠ æˆ

# è®¡ç®—æ–¹æ³•ï¼ˆèŒä¸šåŸºç¡€ + ç­‰çº§ + è£…å¤‡ + Buff + è¢«åŠ¨æŠ€èƒ½ï¼‰
func get_health() -> int:
	return job.health + level.health + equipment.health + buff.health + passive.health

func get_mana() -> int:
	return job.mana + level.mana + equipment.mana + buff.mana + passive.mana

func get_min_attack() -> int:
	return job.min_attack + level.min_attack + equipment.min_attack + buff.min_attack + passive.min_attack

func get_max_attack() -> int:
	return job.max_attack + level.max_attack + equipment.max_attack + buff.max_attack + passive.max_attack

func get_min_magic_attack() -> int:
	return job.min_magic_attack + level.min_magic_attack + equipment.min_magic_attack + buff.min_magic_attack + passive.min_magic_attack

func get_max_magic_attack() -> int:
	return job.max_magic_attack + level.max_magic_attack + equipment.max_magic_attack + buff.max_magic_attack + passive.max_magic_attack
	
func get_min_defense() -> int:
	return job.min_defense + level.min_defense + equipment.min_defense + buff.min_defense + passive.min_defense

func get_max_defense() -> int:
	return job.max_defense + level.max_defense + equipment.max_defense + buff.max_defense + passive.max_defense

func get_min_magic_defense() -> int:
	return job.min_magic_defense + level.min_magic_defense + equipment.min_magic_defense + buff.min_magic_defense + passive.min_magic_defense
	
func get_max_magic_defense() -> int:
	return job.max_magic_defense + level.max_magic_defense + equipment.max_magic_defense + buff.max_magic_defense + passive.max_magic_defense
	
func get_accuracy() -> int:
	return job.accuracy + level.accuracy + equipment.accuracy + buff.accuracy + passive.accuracy

func get_agility() -> int:
	return job.agility + level.agility + equipment.agility + buff.agility + passive.agility

func get_luck() -> int:
	return job.luck + level.luck + equipment.luck + buff.luck + passive.luck

func get_curse() -> int:
	return job.curse + level.curse + equipment.curse + buff.curse + passive.curse

func get_magic_dodge() -> float:
	return job.magic_dodge + level.magic_dodge + equipment.magic_dodge + buff.magic_dodge + passive.magic_dodge

func get_critical_rate() -> float:
	return job.critical_rate + level.critical_rate + equipment.critical_rate + buff.critical_rate + passive.critical_rate

func get_attack_speed() -> float:
	return job.attack_speed + level.attack_speed + equipment.attack_speed + buff.attack_speed + passive.attack_speed

# åºåˆ—åŒ–
func serialize() -> Dictionary:
	return {
		"job": job.serialize(),
		"level": level.serialize(),
		"equipment": equipment.serialize(),
		"buff": buff.serialize(),
		"passive": passive.serialize()  # ğŸ†• åºåˆ—åŒ–è¢«åŠ¨æŠ€èƒ½åŠ æˆ
	}

# ååºåˆ—åŒ–
func deserialize(data: Dictionary):
	if data.has("job"): job.deserialize(data["job"])
	if data.has("level"): level.deserialize(data["level"])
	if data.has("equipment"): equipment.deserialize(data["equipment"])
	if data.has("buff"): buff.deserialize(data["buff"])
	if data.has("passive"): passive.deserialize(data["passive"])  # ğŸ†• ååºåˆ—åŒ–è¢«åŠ¨æŠ€èƒ½åŠ æˆ

func get_class_name() -> String:
	return "PlayerCombatAttributes"


==== res:///core/ecs/data/config_data.gd ====
# ä½é¢‘å˜åŒ–çš„é…ç½®æ•°æ®ï¼ˆå¯åŠ¨æ—¶è®¾å®šï¼Œå¾ˆå°‘å˜åŠ¨ï¼‰
class_name ConfigData extends Resource

# åŸºç¡€å±æ€§
var entity_id: String = ""				# å®ä½“å”¯ä¸€ID
var entity_name: String = ""				# æ˜¾ç¤ºåç§°ï¼ˆæ€ªç‰©/NPCç”¨ï¼‰
var entity_type: String = ""				# player, monster, npc, item
var prefab_path: String = ""				# å¯¹åº”çš„åœºæ™¯æ–‡ä»¶è·¯å¾„

# æŠ€èƒ½å’Œè£…å¤‡é…ç½®
var skills: Array[String] = []
var equipment_slots: Array[String] = []

# è§†è§‰å’Œè¡¨ç°
var sprite_path: String = ""
var collision_shape: String = ""
var scale: Vector2 = Vector2.ONE

# === ç©å®¶ç‰¹æœ‰é…ç½® ===
var character_class: String = "warrior" # warrior, mage, taoist
var gender: String = "male"             # male, female

# === æ€ªç‰©ç‰¹æœ‰é…ç½® ===
var ai_behavior: String = "passive"     # passive, aggressive, neutral
var monster_rank: String = "normal"     # normal, elite, boss, lord

# === è£…å¤‡æ§½ä½é…ç½® ===
var equip_slots: Array[String] = [
	"weapon", "helmet", "necklace", "armor", 
	"bracelet", "ring", "boots"
]

# æ„é€ å‡½æ•°
func _init(
	id: String = "", 
	name: String = "", 
	type: String = "player", 
	char_class: String = "warrior"
):
	entity_id = id
	entity_name = name
	entity_type = type
	character_class = char_class
	
# === å·¥å…·æ–¹æ³• ===
func get_class_display_name() -> String:
	match character_class:
		"warrior": return "æˆ˜å£«"
		"mage": return "æ³•å¸ˆ"
		"taoist": return "é“å£«"
		_: return "æœªçŸ¥èŒä¸š"
		
# æ€ªç‰©ç›¸å…³æ–¹æ³•
func is_monster() -> bool:
	return entity_type == "monster"

func is_player() -> bool:
	return entity_type == "player"

func is_npc() -> bool:
	return entity_type == "npc"

# è·å–è¡Œä¸ºæ¨¡å¼æ˜¾ç¤ºåç§°
func get_behavior_display_name() -> String:
	match ai_behavior:
		"passive": return "è¢«åŠ¨"
		"aggressive": return "ä¸»åŠ¨"
		"neutral": return "ä¸­ç«‹"
		"fleeing": return "é€ƒè·‘"
		_: return "æœªçŸ¥"

# è·å–æ€ªç‰©ç­‰çº§æ˜¾ç¤ºåç§°
func get_rank_display_name() -> String:
	match monster_rank:
		"normal": return "æ™®é€š"
		"elite": return "ç²¾è‹±"
		"boss": return "é¦–é¢†"
		"lord": return "é¢†ä¸»"
		_: return "æœªçŸ¥"
		
func get_display_name() -> String:
	return "%s Lv.1 %s" % [entity_name, get_class_display_name()]

func has_skill(skill_id: String) -> bool:
	return skill_id in skills

func add_skill(skill_id: String) -> void:
	if not has_skill(skill_id):
		skills.append(skill_id)
	


==== res:///core/ecs/data/entity_data.gd ====
# ç»Ÿä¸€æ•°æ®ç®¡ç†å®¹å™¨ï¼Œæ”¯æŒå“åº”å¼æ•°æ®å˜æ›´
class_name EntityData extends Resource

# æ•°æ®ç»„ä»¶å¼•ç”¨
var runtime: RuntimeData = null
var config: ConfigData = null

# === æ•°æ®å˜æ›´ä¿¡å· ===
signal data_changed(property_name: String, old_value, new_value)
signal position_changed(old_pos: Vector2, new_pos: Vector2)
signal health_changed(old_health: int, new_health: int)
signal mana_changed(old_mana: int, new_mana: int)

# æ„é€ å‡½æ•°
func _init(
	runtime_data: RuntimeData = null, 
	config_data: ConfigData = null
):
	runtime = runtime_data if runtime_data else RuntimeData.new()
	config = config_data if config_data else ConfigData.new()

# è½¬å‘è¿è¡Œæ—¶ç»„ä»¶å˜æ›´ä¿¡å·
func _on_runtime_data_changed(property: String, old_value, new_value):
	data_changed.emit("runtime", property, old_value, new_value)

# === åŸºç¡€æ•°æ®è®¿é—® ===
func set_position(new_position: Vector2) -> void:
	if runtime.position != new_position:
		var old_position = runtime.position
		runtime.position = new_position
		position_changed.emit(old_position, new_position)

# === çŠ¶æ€æ£€æŸ¥ ===
func is_alive() -> bool:
	return runtime.is_alive()
	
func has_state_flag(state_flag: int) -> bool:
	return runtime.has_state_flag(state_flag)

func set_state_flag(state_flag: int) -> void:
	var old_flags = runtime.state_flags
	runtime.set_state_flag(state_flag)
	if runtime.state_flags != old_flags:
		data_changed.emit("state_flags", old_flags, runtime.state_flags)

func clear_state_flag(state_flag: int) -> void:
	var old_flags = runtime.state_flags
	runtime.clear_state_flag(state_flag)
	if runtime.state_flags != old_flags:
		data_changed.emit("state_flags", old_flags, runtime.state_flags)

func get_active_states() -> Array:
	return runtime.get_active_states()

# === ä¼¤å®³å’Œæ²»ç–— ===
func take_damage(damage: int) -> void:
	var old_health = runtime.current_health
	runtime.take_damage(damage)
	health_changed.emit(old_health, runtime.current_health)

func heal(amount: int) -> void:
	var old_health = runtime.current_health
	runtime.heal(amount)
	health_changed.emit(old_health, runtime.current_health)

# === å·¥å…·æ–¹æ³• ===
func get_display_name() -> String:
	# ä¼˜å…ˆä½¿ç”¨è¿è¡Œæ—¶æ˜µç§°ï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨é…ç½®åç§°
	if runtime.nickname != "":
		return runtime.nickname
	return config.get_display_name()

func get_character_class() -> String:
	return config.character_class

# === æˆ˜æ–—å±æ€§è®¿é—®ï¼ˆå§”æ‰˜ç»™RuntimeDataï¼‰===
func get_position() -> Vector2: return runtime.position
	
func get_level() -> int: return runtime.level

func get_experience() -> int: return runtime.experience
	
func get_health() -> float: return runtime.get_health()

func get_max_health() -> float: return runtime.get_max_health()

func get_mana() -> float: return runtime.get_mana()

func get_max_mana() -> float: return runtime.get_max_mana()

func get_min_attack() -> int:return runtime.get_min_attack()

func get_max_attack() -> int:return runtime.get_max_attack()

func get_min_magic_attack() -> int:return runtime.get_min_()

func get_max_magic_attack() -> int:return runtime.get_max_magic_attack()

func get_min_defense() -> int:return runtime.get_min_defense()

func get_max_defense() -> int:return runtime.get_max_defense()

func get_min_magic_defense() -> int:return runtime.get_min_magic_defense()
	
func get_max_magic_defense() -> int:return runtime.get_max_magic_defense()

func get_accuracy() -> int:return runtime.get_accuracy()

func get_agility() -> int:return runtime.get_agility()

func get_luck() -> int:return runtime.get_luck()

func get_curse() -> int:return runtime.get_curse()

func get_critical_rate() -> float:return runtime.get_critical_rate()

func get_magic_dodge() -> float:return runtime.get_magic_dodge()

func get_attack_speed() -> float:return runtime.get_attack_speed()

# åºåˆ—åŒ–æ•°æ®ï¼ˆç”¨äºå­˜æ¡£ï¼‰
func serialize() -> Dictionary:
	return {
		"runtime": runtime.serialize(),
		"config": config.serialize()
	}

# ååºåˆ—åŒ–æ•°æ®
func deserialize(data: Dictionary):
	if data.has("runtime"):
		runtime.deserialize(data["runtime"])
	if data.has("config"):
		config.deserialize(data["config"])


==== res:///core/ecs/data/runtime_data.gd ====
# é«˜é¢‘å˜åŒ–çš„è¿è¡Œæ—¶æ•°æ®
class_name RuntimeData extends Resource

# çŠ¶æ€æ ‡å¿—ä½å®šä¹‰ï¼ˆä½¿ç”¨ä½è¿ç®—ï¼Œæ”¯æŒå¤šä¸ªçŠ¶æ€åŒæ—¶å­˜åœ¨ï¼‰
enum StateFlags {
	IN_BATTLE = 1,       # æˆ˜æ–—ä¸­ - å½±å“è‡ªåŠ¨å›è¡€å›è“ã€æŸäº›æŠ€èƒ½æ•ˆæœ
	POISONED = 2,        # ä¸­æ¯’ - æŒç»­æ‰£è¡€ï¼Œå½±å“ç§»åŠ¨é€Ÿåº¦
	FROZEN = 4,          # å†°å†» - æ— æ³•ç§»åŠ¨å’Œæ”»å‡»ï¼Œé˜²å¾¡åŠ›æå‡
	PARALYZED = 8,       # éº»ç—¹ - æ— æ³•ç§»åŠ¨ï¼Œå¯ä»¥æ”»å‡»ä½†å‘½ä¸­ç‡ä¸‹é™
	INVISIBLE = 16,      # éšèº« - æ€ªç‰©æ— æ³•å‘ç°ï¼Œæ”»å‡»åæ˜¾å½¢
	HIDDEN = 32,         # æ½œè¡Œ - ç§»åŠ¨é€Ÿåº¦ä¸‹é™ï¼Œæ€ªç‰©è¾ƒéš¾å‘ç°
	DEAD = 64,           # æ­»äº¡ - æ— æ³•è¿›è¡Œä»»ä½•æ“ä½œï¼Œç­‰å¾…å¤æ´»
	TRANSMITTING = 128,  # ä¼ é€ä¸­ - æ— æ•ŒçŠ¶æ€ï¼Œæ— æ³•è¢«æ”»å‡»
	SILENCED = 256,      # æ²‰é»˜ - æ— æ³•ä½¿ç”¨æŠ€èƒ½ï¼Œåªèƒ½æ™®é€šæ”»å‡»
	STUNNED = 512        # çœ©æ™• - æ— æ³•ç§»åŠ¨å’Œæ”»å‡»ï¼Œé˜²å¾¡åŠ›ä¸‹é™
}
# ä½¿ç”¨ç¤ºä¾‹ï¼š
# è®¾ç½®çŠ¶æ€ï¼šstate_flags |= StateFlags.POISONED | StateFlags.SILENCED
# æ¸…é™¤çŠ¶æ€ï¼šstate_flags &= ~StateFlags.POISONED
# æ£€æŸ¥çŠ¶æ€ï¼š(state_flags & StateFlags.POISONED) != 0

# æˆ˜æ–—å±æ€§å®¹å™¨ï¼ˆç»Ÿä¸€ç±»å‹ï¼‰
var combat: CombatAttributesBase = null

# ä½ç½®å’Œç§»åŠ¨ç›¸å…³
var position: Vector2 = Vector2.ZERO
var velocity: Vector2 = Vector2.ZERO
var rotation: float = 0.0
var move_direction: Vector2 = Vector2.ZERO

# ç”Ÿå‘½å€¼å’ŒçŠ¶æ€
var current_health: int = 100
var current_mana: int = 50

# ç»éªŒä¸ç­‰çº§
var experience: int = 0
var level: int = 1

# çŠ¶æ€æ ‡å¿—
var state_flags: int = 0

# ç©å®¶æ˜¾ç¤ºåç§°
var nickname: String = ""

func _init(initial_position: Vector2 = Vector2.ZERO):
	position = initial_position
	
# ä¼¤å®³å’Œæ²»ç–—
func take_damage(damage: int):
	current_health -= damage
	current_health = max(0, current_health)
	if current_health == 0:
		set_state_flag(StateFlags.DEAD)

func heal(amount: int):
	current_health += amount
	current_health = min(current_health, get_max_health())
	if current_health > 0 and has_state_flag(StateFlags.DEAD):
		clear_state_flag(StateFlags.DEAD)
		
# çŠ¶æ€æ£€æŸ¥
func is_alive() -> bool:
	return current_health > 0 and not has_state_flag(StateFlags.DEAD)
	
# çŠ¶æ€æ ‡å¿—æ–¹æ³•
func set_state_flag(flag: int):
	state_flags |= flag

func clear_state_flag(flag: int):
	state_flags &= ~flag

func has_state_flag(flag: int) -> bool:
	return (state_flags & flag) != 0

func get_active_states() -> Array:
	var states = []
	for flag in StateFlags.values():
		if has_state_flag(flag):
			states.append(StateFlags.keys()[StateFlags.values().find(flag)])
	return states

# åŸºç¡€å±æ€§è®¿é—®
func get_health() -> int:
	return current_health

func get_max_health() -> int:
	return combat.get_max_health() if combat else 0
	
func get_mana() -> int:
	return current_mana

func get_max_mana() -> int:
	return combat.get_max_mana() if combat else 0
	
func get_min_attack() -> int:
	return combat.get_min_attack() if combat else 0

func get_max_attack() -> int:
	return combat.get_max_attack() if combat else 0

func get_min_magic_attack() -> int:
	return combat.get_min_magic_attack() if combat else 0

func get_max_magic_attack() -> int:
	return combat.get_max_magic_attack() if combat else 0
	
func get_min_defense() -> int:
	return combat.get_min_defense() if combat else 0

func get_max_defense() -> int:
	return combat.get_max_defense() if combat else 0

func get_min_magic_defense() -> int:
	return combat.get_min_magic_defense() if combat else 0
	
func get_max_magic_defense() -> int:
	return combat.get_max_magic_defense() if combat else 0

func get_accuracy() -> int:
	return combat.get_accuracy() if combat else 0

func get_agility() -> int:
	return combat.get_agility() if combat else 0

func get_luck() -> int:
	return combat.get_luck() if combat else 0

func get_curse() -> int:
	return combat.get_curse() if combat else 0

func get_magic_dodge() -> float:
	return combat.get_magic_dodge() if combat else 0.0

func get_critical_rate() -> float:
	return combat.get_critical_rate() if combat else 0.0

func get_attack_speed() -> float:
	return combat.get_attack_speed() if combat else 0.0
	
# åºåˆ—åŒ–
func serialize() -> Dictionary:
	var data = {
		"position": {"x": position.x, "y": position.y},
		"current_health": current_health,
		"current_mana": current_mana,
		"experience": experience,
		"level": level,
		"state_flags": state_flags,
		"nickname": nickname
	}
	
	# åºåˆ—åŒ–æˆ˜æ–—å±æ€§
	if combat:
		data["combat_type"] = combat.get_class_name()  # å­˜å‚¨å…·ä½“ç±»å‹
		data["combat"] = combat.serialize()
	
	return data

# ååºåˆ—åŒ–
func deserialize(data: Dictionary):
	position = Vector2(data.get("position", {}).get("x", 0), data.get("position", {}).get("y", 0))
	current_health = data.get("current_health", 0)
	current_mana = data.get("current_mana", 0)
	experience = data.get("experience", 0)
	level = data.get("level", 1)
	state_flags = data.get("state_flags", 0)
	nickname = data.get("nickname", "")
	
	# ååºåˆ—åŒ–æˆ˜æ–—å±æ€§
	var combat_type = data.get("combat_type", "")
	var combat_data = data.get("combat", {})
	
	match combat_type:
		"MonsterCombatAttributes":
			combat = MonsterCombatAttributes.new()
		"PlayerCombatAttributes":
			combat = PlayerCombatAttributes.new()
	
	if combat:
		combat.deserialize(combat_data)


==== res:///core/ecs/entities/game_entity.gd ====
# game_entity.gd
extends CharacterBody2D
class_name GameEntity

## å…±äº«çš„ CircleShape2D èµ„æº
var data: EntityData
var collision_shape: CollisionShape2D

# åˆå§‹åŒ–å‡½æ•°
func setup(entity_data: EntityData) -> void:
	#"""åˆå§‹åŒ–å®ä½“ï¼Œç»‘å®šæ•°æ®å¹¶è¿æ¥ä¿¡å·"""
	data = entity_data
	
	# è¿æ¥åŸºç¡€è¡¨ç°ç›¸å…³çš„ä¿¡å·
	_connect_signals()
	
	_initial_sync()
	print("GameEntity åˆå§‹åŒ–å®Œæˆ: ", data.config.entity_name)

# åˆå§‹åŒæ­¥ï¼šç”¨å½“å‰æ•°æ®åˆå§‹åŒ–åŸºç¡€è¡¨ç°
func _initial_sync() -> void:
   # """å°†åˆå§‹æ•°æ®åŒæ­¥åˆ°èŠ‚ç‚¹è¡¨ç°"""
	position = data.get_position()
	visible = data.runtime.is_active
	
	# åˆ›å»ºç¢°æ’ç›’
	_create_collision_shape()
	
	print("å®ä½“åˆå§‹åŒ–: %s ä½ç½®: %s" % [data.config.entity_name, position])
	
# è¿æ¥æ•°æ®å˜åŒ–çš„ä¿¡å·
func _connect_signals() -> void:
	pass
	
# ç»Ÿä¸€ç§»åŠ¨æ¥å£ï¼Œå­ç±»ç›´æ¥è°ƒ
func move(direction: Vector2, speed: float) -> void:
	velocity = direction * speed
	move_and_slide()

# åˆ›å»ºç¢°æ’ç›’
func _create_collision_shape() -> void:
	collision_shape = CollisionShape2D.new()
	collision_shape.shape = Game.SHARED_CIRCLE_44
	add_child(collision_shape)
	
	# 1-terrain 2-entity 3-bullet 4-trigger
	var layer := 0
	var mask  := 0
	match data.config.entity_type:
		"player":
			layer = 1<<1          # åªåœ¨ç¬¬ 2 å±‚ï¼ˆentityï¼‰
			mask  = (1<<0) | (1<<1) | (1<<3)   # æ’ terrain+entity+trigger
		"monster":
			layer = 1<<1
			mask  = (1<<0) | (1<<1) | (1<<2)   # æ’ terrain+entity+bullet
		"npc":
			layer = 1<<1
			mask  = 1<<0                       # åªæ’ terrain
		"item":
			layer = 1<<3                       # æ”¾åœ¨ trigger å±‚
			mask  = 0                          # ä¸ä¸»åŠ¨æ’ä»»ä½•å±‚

	set_collision_layer(layer)
	set_collision_mask(mask)
	


==== res:///core/ecs/systems/system_base.gd ====
# res://core/ecs/systems/system_base.gd
# è®¾è®¡åŸåˆ™ï¼š
#   - æ— çŠ¶æ€ï¼šç³»ç»Ÿæœ¬èº«ä¸å­˜å‚¨ä¸šåŠ¡æ•°æ®ï¼Œåªå¤„ç†EntityData
#   - å•ä¸€èŒè´£ï¼šæ¯ä¸ªç³»ç»Ÿåªè´Ÿè´£ä¸€ä¸ªç‰¹å®šçš„åŠŸèƒ½é¢†åŸŸ
#   - æ‰¹é‡å¤„ç†ï¼šæ”¯æŒæŒ‰æ‰¹å¤„ç†å®ä½“ï¼Œä¼˜åŒ–æ€§èƒ½
class_name SystemBase extends Node2D

# ç³»ç»Ÿå…³æ³¨çš„å®ä½“åˆ—è¡¨
var entities: Array[GameEntity] = []

# ç³»ç»Ÿé…ç½®
var update_priority: int = 0          # æ›´æ–°ä¼˜å…ˆçº§ï¼ˆæ•°å€¼è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼‰
var enabled: bool = true              # ç³»ç»Ÿæ˜¯å¦å¯ç”¨

# æ‰¹å¤„ç†é…ç½®
var use_batch_processing: bool = true # æ˜¯å¦å¯ç”¨åˆ†æ‰¹å¤„ç†
var batch_size: int = 20              # æ¯æ‰¹å¤„ç†çš„å®ä½“æ•°é‡
var batch_threshold: int = 50         # å¯ç”¨åˆ†æ‰¹çš„å®ä½“æ•°é‡é˜ˆå€¼
var _current_batch_index: int = 0     # å½“å‰æ‰¹å¤„ç†ä½ç½®

# ç³»ç»Ÿæ ‡è¯†
var system_name: String = "UnnamedSystem"
var system_type: String = "Generic"    # Core, Gameplay, Render, Infrastructure

# è™šå‡½æ•°ï¼šç³»ç»Ÿåˆå§‹åŒ–
func _initialize() -> void:
	# ç³»ç»Ÿåˆå§‹åŒ–ï¼Œåœ¨æ·»åŠ åˆ°SystemManageræ—¶è°ƒç”¨
	print("ç³»ç»Ÿåˆå§‹åŒ–: ", system_name)
	pass

# è™šå‡½æ•°ï¼šç³»ç»Ÿæ¸…ç†
func _shutdown() -> void:
	# ç³»ç»Ÿæ¸…ç†ï¼Œåœ¨ä»SystemManagerç§»é™¤æ—¶è°ƒç”¨
	print("ç³»ç»Ÿå…³é—­: ", system_name)
	entities.clear()
	_current_batch_index = 0

# ä¸»æ›´æ–°å‡½æ•° - ç”±SystemManageræ¯å¸§è°ƒç”¨
func process_system(delta: float) -> void:
	# ç³»ç»Ÿä¸»æ›´æ–°å‡½æ•°
	if not enabled or entities.is_empty():
		return
	
	# æ ¹æ®é˜ˆå€¼å†³å®šæ˜¯å¦å¯ç”¨åˆ†æ‰¹å¤„ç†
	if use_batch_processing and entities.size() > batch_threshold:
		_process_with_batching(delta)
	else:
		_process_all_entities(delta)

# åˆ†æ‰¹å¤„ç†æ¨¡å¼
func _process_with_batching(delta: float) -> void:
	# åˆ†æ‰¹å¤„ç†å®ä½“
	var start_idx = _current_batch_index
	var end_idx = min(start_idx + batch_size, entities.size())
	
	# å¤„ç†å½“å‰æ‰¹æ¬¡
	for i in range(start_idx, end_idx):
		var entity = entities[i]
		if entity and entity.is_entity_active():
			# â›” ä¸ç¬¦åˆæ¡ä»¶ç›´æ¥èµ°äºº
			if not _should_process_entity(entity):
				continue
			_process_entity(entity, delta)
	
	# æ›´æ–°æ‰¹å¤„ç†ä½ç½®ï¼ˆå¾ªç¯ï¼‰
	_current_batch_index = end_idx
	if _current_batch_index >= entities.size():
		_current_batch_index = 0

# å…¨é‡å¤„ç†æ¨¡å¼
func _process_all_entities(delta: float) -> void:
	# å…¨é‡å¤„ç†æ‰€æœ‰å®ä½“
	for entity in entities:
		if entity and entity.is_entity_active():
			# â›” ä¸ç¬¦åˆæ¡ä»¶ç›´æ¥èµ°äºº
			if not _should_process_entity(entity):
				continue
			_process_entity(entity, delta)

# å­ç±»é‡å†™æ­¤å‡½æ•°å³å¯ï¼Œé»˜è®¤å…¨é€šè¿‡
func _should_process_entity(_entity: GameEntity) -> bool:
	return true
	
# è™šå‡½æ•°ï¼šå¤„ç†å•ä¸ªå®ä½“
func _process_entity(_entity: GameEntity, _delta: float) -> void:
	# å¤„ç†å•ä¸ªå®ä½“ï¼ˆå­ç±»å¿…é¡»é‡å†™æ­¤æ–¹æ³•ï¼‰
	push_error("SystemBase._process_entity() å¿…é¡»è¢«å­ç±»é‡å†™: ", system_name)

# å®ä½“ç®¡ç†
func register_entity(entity: GameEntity) -> void:
	# å‘ç³»ç»Ÿæ³¨å†Œå®ä½“
	if entity and not entities.has(entity):
		entities.append(entity)
		_on_entity_registered(entity)

func unregister_entity(entity: GameEntity) -> void:
	# ä»ç³»ç»Ÿæ³¨é”€å®ä½“
	if entities.has(entity):
		entities.erase(entity)
		_on_entity_unregistered(entity)
		# å¦‚æœåˆ é™¤çš„å®ä½“åœ¨_current_batch_indexä¹‹å‰ï¼Œéœ€è¦è°ƒæ•´ç´¢å¼•
		if entities.size() > 0 and _current_batch_index >= entities.size():
			_current_batch_index = 0

func clear_entities() -> void:
	# æ¸…ç©ºæ‰€æœ‰å®ä½“
	for entity in entities:
		_on_entity_unregistered(entity)
	entities.clear()
	_current_batch_index = 0

# å®ä½“äº‹ä»¶å›è°ƒ
func _on_entity_registered(entity: GameEntity) -> void:
	# å®ä½“æ³¨å†Œæ—¶çš„å›è°ƒ
	print("å®ä½“æ³¨å†Œåˆ°ç³»ç»Ÿ: ", system_name, " - ", entity.data.config.entity_name)

func _on_entity_unregistered(entity: GameEntity) -> void:
	# å®ä½“æ³¨é”€æ—¶çš„å›è°ƒ
	print("å®ä½“ä»ç³»ç»Ÿæ³¨é”€: ", system_name, " - ", entity.data.config.entity_name)

# ç³»ç»ŸçŠ¶æ€æ§åˆ¶
func enable() -> void:
	# å¯ç”¨ç³»ç»Ÿ
	if not enabled:
		enabled = true
		print("ç³»ç»Ÿå¯ç”¨: ", system_name)

func disable() -> void:
	# ç¦ç”¨ç³»ç»Ÿ
	if enabled:
		enabled = false
		print("ç³»ç»Ÿç¦ç”¨: ", system_name)

func toggle_enabled() -> bool:
	# åˆ‡æ¢ç³»ç»Ÿå¯ç”¨çŠ¶æ€
	enabled = not enabled
	print("ç³»ç»ŸçŠ¶æ€åˆ‡æ¢: ", system_name, " -> ", enabled)
	return enabled

# æ‰¹å¤„ç†é…ç½®æ–¹æ³•
func set_batch_settings(use_batch: bool, threshold: int, size: int) -> void:
	# è®¾ç½®æ‰¹å¤„ç†å‚æ•°
	use_batch_processing = use_batch
	batch_threshold = max(1, threshold)
	batch_size = max(1, size)
	print("æ‰¹å¤„ç†è®¾ç½®æ›´æ–°: ", system_name, " é˜ˆå€¼=", threshold, " æ‰¹å¤§å°=", size)

func disable_batching() -> void:
	# ç¦ç”¨æ‰¹å¤„ç†
	use_batch_processing = false
	print("æ‰¹å¤„ç†å·²ç¦ç”¨: ", system_name)

# å·¥å…·å‡½æ•°
func get_entity_count() -> int:
	# è·å–å½“å‰ç®¡ç†çš„å®ä½“æ•°é‡
	return entities.size()

func is_system_processing() -> bool:
	# æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æ­£åœ¨å¤„ç†ï¼ˆå¯ç”¨ä¸”æœ‰å®ä½“ï¼‰
	return enabled and not entities.is_empty()

func get_batch_info() -> Dictionary:
	# è·å–æ‰¹å¤„ç†ä¿¡æ¯
	return {
		"use_batch_processing": use_batch_processing,
		"batch_threshold": batch_threshold,
		"batch_size": batch_size,
		"current_batch_index": _current_batch_index,
		"is_using_batch": use_batch_processing and entities.size() > batch_threshold
	}

func get_system_info() -> Dictionary:
	# è·å–ç³»ç»Ÿä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
	return {
		"name": system_name,
		"type": system_type,
		"enabled": enabled,
		"entity_count": entities.size(),
		"priority": update_priority,
		"batch_info": get_batch_info()
	}

# è°ƒè¯•åŠŸèƒ½
func print_debug_info() -> void:
	# æ‰“å°ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯
	var info = get_system_info()
	print("=== ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯ ===")
	for key in info:
		if key != "batch_info":
			print("  ", key, ": ", info[key])
	
	var batch_info = info["batch_info"]
	print("  æ‰¹å¤„ç†ä¿¡æ¯:")
	for key in batch_info:
		print("    ", key, ": ", batch_info[key])
	
	print("  å®ä½“åˆ—è¡¨:")
	for entity in entities:
		if entity and entity.data:
			print("    - ", entity.data.config.entity_name)


==== res:///exported_scripts.gd ====
@tool
extends EditorScript

const EXPORT_FILE := "exported_scripts.txt"

func _init() -> void:
	# 1) å¯¼å‡ºæ‰€æœ‰ .gd æ–‡ä»¶
	_export_all_scripts()
	

# ---------- 1. å¯¼å‡ºè„šæœ¬ ----------
func _export_all_scripts() -> void:
	var files := _list_all_gd_files("res://")
	var content := ""
	for path in files:
		var file := FileAccess.open(path, FileAccess.READ)
		if file:
			content += "\n\n==== %s ====\n" % path
			content += file.get_as_text()
			file.close()
	var out := FileAccess.open(EXPORT_FILE, FileAccess.WRITE)
	out.store_string(content)
	out.close()
	print("ğŸ“ å·²å¯¼å‡º %d ä¸ªè„šæœ¬ -> %s" % [files.size(), EXPORT_FILE])

# é€’å½’æ”¶é›† .gd
func _list_all_gd_files(dir: String) -> PackedStringArray:
	var list := PackedStringArray()
	var dir_access := DirAccess.open(dir)
	if dir_access:
		dir_access.list_dir_begin()
		var name := dir_access.get_next()
		while name != "":
			var full := dir + "/" + name
			if dir_access.current_is_dir() and not name.begins_with("."):
				list.append_array(_list_all_gd_files(full))
			elif name.ends_with(".gd"):
				list.append(full)
			name = dir_access.get_next()
	return list


==== res:///global/game.gd ====
extends Node

const SHARED_CIRCLE_44 = preload("uid://ljqm0hcpijnt")
const SHARED_CIRCLE_72 = preload("uid://dlwg14a8t4brl")
const SHARED_CIRCLE_108 = preload("uid://cgqk4mwv7hg0i")

# é»˜è®¤ç³»ç»Ÿæ³¨å†Œé…ç½®
var system_registrations: Array = [
	# æ ¸å¿ƒç³»ç»Ÿ
	#{
		#"script": load("res://core/ecs/systems/infrastructure/touch_input_system.gd"),
		#"group": "infrastructure",
		#"name": "TouchInputSystem ",
		#"needs_scene_tree": true,  # ğŸ¯ éœ€è¦åœºæ™¯æ ‘æ¥å¤„ç†è¾“å…¥äº‹ä»¶
		#"priority": 1  # ğŸ¯ æœ€é«˜ä¼˜å…ˆçº§
	#},
]


==== res:///global/system_manager.gd ====
# res://global/system_manager.gd
extends Node
# ä½œç”¨ï¼šECSæ¶æ„çš„æ ¸å¿ƒè°ƒåº¦å™¨ï¼Œç®¡ç†å’Œåè°ƒæ‰€æœ‰ç³»ç»Ÿçš„æ‰§è¡Œ
# èŒè´£ï¼š
#   - æ³¨å†Œå’Œç®¡ç†æ‰€æœ‰ç³»ç»Ÿå®ä¾‹
#   - æŒ‰ä¼˜å…ˆçº§è°ƒåº¦ç³»ç»Ÿæ‰§è¡Œ
#   - æä¾›ç³»ç»Ÿé—´çš„é€šä¿¡æ¡¥æ¢
#   - æ”¯æŒç³»ç»Ÿçš„åŠ¨æ€å¯ç”¨/ç¦ç”¨

# Godotå•ä¾‹ï¼šä¸éœ€è¦class_nameï¼Œç›´æ¥åœ¨AutoLoadä¸­åŠ è½½

# ç³»ç»Ÿæ³¨å†Œè¡¨
var _systems: Dictionary = {}           # ç³»ç»Ÿåç§° -> ç³»ç»Ÿå®ä¾‹
var _system_instances: Array = []       # æ‰€æœ‰ç³»ç»Ÿå®ä¾‹
var _update_order: Array = []           # æŒ‰ä¼˜å…ˆçº§æ’åºçš„ç³»ç»Ÿåç§°åˆ—è¡¨

# ç³»ç»Ÿç»„åˆ«
var _system_groups: Dictionary = {
	"core": [],        # æ ¸å¿ƒç³»ç»Ÿï¼šç§»åŠ¨ã€æˆ˜æ–—ç­‰
	"gameplay": [],    # ç©æ³•ç³»ç»Ÿï¼šè£…å¤‡ã€æŠ€èƒ½ç­‰  
	"render": [],      # æ¸²æŸ“ç³»ç»Ÿï¼šåŠ¨ç”»ã€UIç­‰
	"infrastructure": [] # åŸºç¡€è®¾æ–½ï¼šç½‘ç»œã€å­˜æ¡£ç­‰
}

# æ€§èƒ½ç›‘æ§
var _performance_counter: int = 0       # æ€§èƒ½ç»Ÿè®¡è®¡æ•°å™¨ï¼ˆ0-60å¾ªç¯ï¼‰
var _system_performance: Dictionary = {} # ç³»ç»Ÿæ€§èƒ½æ•°æ®

var _check_frame:int = 300

# å°±ç»ªå‡½æ•°
func _ready():
	print("SystemManager åˆå§‹åŒ–å®Œæˆ")
	_setup_default_systems()
	
# æ¯å¸§æ›´æ–°
func _process(delta: float):
	_performance_counter += 1
	_update_systems(delta)
	
	# æ¯60å¸§è¾“å‡ºä¸€æ¬¡æ€§èƒ½æŠ¥å‘Šå¹¶é‡ç½®
	if _performance_counter >= _check_frame:
		_print_performance_report()
		_reset_performance_counters()
		_performance_counter = 0

# è®¾ç½®é»˜è®¤ç³»ç»Ÿ
func _setup_default_systems():
	print("å¼€å§‹æ³¨å†Œé»˜è®¤ç³»ç»Ÿ...")
	
	for registration in Game.system_registrations:
		_register_system_internal(registration)
	
	print("é»˜è®¤ç³»ç»Ÿæ³¨å†Œå®Œæˆ")

# å†…éƒ¨ç³»ç»Ÿæ³¨å†Œæ–¹æ³•
func _register_system_internal(registration: Dictionary):
	var system_script = registration.get("script")
	var group = registration.get("group", "core")
	var needs_scene_tree = registration.get("needs_scene_tree", false)
	var priority = registration.get("priority", 50)  # ğŸ¯ è·å–ä¼˜å…ˆçº§
	
	if not system_script:
		push_error("ç³»ç»Ÿæ³¨å†Œç¼ºå°‘script")
		return
	
	var system_instance = system_script.new()
	
	# ğŸ¯ è®¾ç½®ç³»ç»Ÿä¼˜å…ˆçº§
	system_instance.update_priority = priority
	
	if needs_scene_tree:
		add_child(system_instance)
		system_instance.name = registration.get("name", "UnnamedSystem")
		
	if register_system(system_instance, group, needs_scene_tree):
		print("âœ… ç³»ç»Ÿæ³¨å†ŒæˆåŠŸ: ", system_instance.system_name, " ä¼˜å…ˆçº§: ", priority)
	else:
		push_error("âŒ ç³»ç»Ÿæ³¨å†Œå¤±è´¥")

# æ³¨å†Œç³»ç»Ÿ
func register_system(system:SystemBase, group: String = "core", needs_scene_tree: bool = false) -> bool:
	# ç®€å•çš„ç±»å‹æ£€æŸ¥
	if system == null:
		push_error("æ³¨å†Œå¤±è´¥ï¼šç³»ç»Ÿä¸º null")
		return false
	
	# å…ˆåˆå§‹åŒ–ç³»ç»Ÿï¼Œè®©ç³»ç»Ÿè®¾ç½®è‡ªå·±çš„åç§°
	if system.has_method("_initialize"):
		system._initialize()
	
	# åˆå§‹åŒ–åå†è·å–ç³»ç»Ÿåç§°
	var system_name = system.system_name
	print("æ­£åœ¨æ³¨å†Œç³»ç»Ÿ: ", system_name)
	
	if _systems.has(system_name):
		push_error("ç³»ç»Ÿå·²å­˜åœ¨: " + system_name)
		return false
	
	# æ³¨å†Œç³»ç»Ÿ
	_systems[system_name] = system
	_system_instances.append(system)
	
	# æ·»åŠ åˆ°ç»„åˆ«
	if _system_groups.has(group):
		_system_groups[group].append(system_name)
	else:
		_system_groups[group] = [system_name]
	
	# æ›´æ–°æ‰§è¡Œé¡ºåº
	_update_execution_order()
		
	print("ç³»ç»Ÿæ³¨å†ŒæˆåŠŸ: ", system_name, " ç»„åˆ«: ", group)
	
	# é€šçŸ¥å…¶ä»–ç³»ç»Ÿæœ‰æ–°ç³»ç»Ÿæ³¨å†Œ
	_notify_system_registered(system.system_name)
	
	return true

func _notify_system_registered(system_name: String):
	# å…¶ä»–ç³»ç»Ÿå¯ä»¥ç›‘å¬è¿™ä¸ªé€šçŸ¥æ¥æ›´æ–°ä¾èµ–
	for system in _system_instances:
		if system.has_method("_on_system_registered"):
			system._on_system_registered(system_name)
	
# æ³¨é”€ç³»ç»Ÿ
func unregister_system(system_name: String) -> bool:
	if not _systems.has(system_name):
		push_error("ç³»ç»Ÿä¸å­˜åœ¨: " + system_name)
		return false
	
	var system = _systems[system_name]
	
	# æ‰§è¡Œç³»ç»Ÿæ¸…ç†
	if system.has_method("_shutdown"):
		system._shutdown()
	
	# ä»æ‰€æœ‰ç»„åˆ«ä¸­ç§»é™¤
	for group in _system_groups:
		_system_groups[group].erase(system_name)
	
	# ä»æ³¨å†Œè¡¨ä¸­ç§»é™¤
	_systems.erase(system_name)
	_system_instances.erase(system)
	_update_order.erase(system_name)
	
	print("ç³»ç»Ÿæ³¨é”€æˆåŠŸ: ", system_name)
	return true

# è·å–ç³»ç»Ÿ
func get_system(system_name: String):
	return _systems.get(system_name)

# æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å­˜åœ¨
func has_system(system_name: String) -> bool:
	return _systems.has(system_name)

# æ›´æ–°ç³»ç»Ÿæ‰§è¡Œé¡ºåº
func _update_execution_order():
	# æŒ‰ä¼˜å…ˆçº§æ’åº
	_system_instances.sort_custom(_compare_system_priority)
	_update_order.clear()
	
	for system in _system_instances:
		_update_order.append(system.system_name)

# ç³»ç»Ÿä¼˜å…ˆçº§æ¯”è¾ƒå‡½æ•°
func _compare_system_priority(a, b) -> bool:
	return a.update_priority < b.update_priority

# ç³»ç»Ÿæ›´æ–°å¾ªç¯
func _update_systems(delta: float):
	for system_name in _update_order:
		var system = _systems[system_name]
		if system and system.enabled:
			var system_start_time = Time.get_ticks_usec()
			
			# æ‰§è¡Œç³»ç»Ÿæ›´æ–°
			system.process_system(delta)
			
			# è®°å½•æ€§èƒ½æ•°æ®
			var system_time = Time.get_ticks_usec() - system_start_time
			_record_system_performance(system_name, system_time)

# è®°å½•ç³»ç»Ÿæ€§èƒ½
func _record_system_performance(system_name: String, execution_time: int):
	if not _system_performance.has(system_name):
		_system_performance[system_name] = {
			"total_time": 0,
			"max_time": 0,
			"call_count": 0,
			"average_time": 0
		}
	
	var perf = _system_performance[system_name]
	perf.total_time += execution_time
	perf.call_count += 1
	perf.max_time = max(perf.max_time, execution_time)
	perf.average_time = perf.total_time / perf.call_count

# é‡ç½®æ€§èƒ½è®¡æ•°å™¨
func _reset_performance_counters():
	for system_name in _system_performance:
		_system_performance[system_name].call_count = 0
		_system_performance[system_name].total_time = 0

# è¾“å‡ºæ€§èƒ½æŠ¥å‘Š
func _print_performance_report():
	print("=== ç³»ç»Ÿæ€§èƒ½æŠ¥å‘Š (é‡‡æ ·%då¸§) ===" % _check_frame)
	
	var total_system_time = 0
	var has_data = false
	
	for system_name in _system_performance:
		var perf = _system_performance[system_name]
		if perf.call_count > 0:
			has_data = true
			total_system_time += perf.average_time
			print("  %s: å¹³å‡%.2fÎ¼s, æœ€å¤§%dÎ¼s, è°ƒç”¨%dæ¬¡" % [
				system_name, perf.average_time, perf.max_time, perf.call_count
			])
	
	if has_data:
		print("  æ€»ç³»ç»Ÿæ—¶é—´: %.2fÎ¼s" % total_system_time)
		print("  æ´»è·ƒç³»ç»Ÿæ•°é‡: ", _get_active_system_count())
	else:
		print("  æš‚æ— æ€§èƒ½æ•°æ®")

# è·å–æ´»è·ƒç³»ç»Ÿæ•°é‡
func _get_active_system_count() -> int:
	var count = 0
	for system in _system_instances:
		if system.enabled and system.is_system_processing():
			count += 1
	return count

# æŒ‰ç»„åˆ«å¯ç”¨/ç¦ç”¨ç³»ç»Ÿ
func set_group_enabled(group: String, enabled: bool):
	if not _system_groups.has(group):
		push_error("ç³»ç»Ÿç»„åˆ«ä¸å­˜åœ¨: " + group)
		return
	
	for system_name in _system_groups[group]:
		var system = _systems[system_name]
		if system:
			if enabled:
				system.enable()
			else:
				system.disable()

# è·å–ç³»ç»Ÿä¿¡æ¯
func get_system_info() -> Dictionary:
	var info = {
		"total_systems": _system_instances.size(),
		"active_systems": _get_active_system_count(),
		"system_groups": {},
		"performance_data": _system_performance.duplicate()
	}
	
	for group in _system_groups:
		info["system_groups"][group] = _system_groups[group].size()
	
	return info

# è°ƒè¯•åŠŸèƒ½
func print_debug_info():
	var info = get_system_info()
	print("=== SystemManager è°ƒè¯•ä¿¡æ¯ ===")
	print("æ€»ç³»ç»Ÿæ•°é‡: ", info.total_systems)
	print("æ´»è·ƒç³»ç»Ÿæ•°é‡: ", info.active_systems)
	print("ç³»ç»Ÿç»„åˆ«åˆ†å¸ƒ:")
	for group in info.system_groups:
		print("  ", group, ": ", info.system_groups[group])
	
	print("ç³»ç»Ÿæ‰§è¡Œé¡ºåº:")
	for i in range(_update_order.size()):
		var system = _systems[_update_order[i]]
		print("  %d. %s (ä¼˜å…ˆçº§: %d)" % [i + 1, system.system_name, system.update_priority])

# å®ä½“æ³¨å†Œåˆ°æ‰€æœ‰ç›¸å…³ç³»ç»Ÿ
func register_entity_to_systems(entity):
	for system in _system_instances:
		system.register_entity(entity)

# å®ä½“ä»æ‰€æœ‰ç³»ç»Ÿæ³¨é”€
func unregister_entity_from_systems(entity):
	for system in _system_instances:
		system.unregister_entity(entity)
